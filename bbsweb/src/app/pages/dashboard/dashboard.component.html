<div *ngIf="hasPrivilege(Permissions.VIEW_MAIN_DASHBOARD)" class="mb-6 rounded-lg custom-panel max-w-7xl mx-auto">
    <ng-template pTemplate="title">
        <div class="flex items-center p-3 rounded-t-lg">
            <i class="pi pi-th-large mr-2 text-2xl"></i>
            <h1 class="text-2xl font-semibold">Admin Dashboard</h1>
        </div>
    </ng-template>

    <div class="p-4">
        <p class="mb-6 ml-1 text-lg font-medium">{{ greeting }}, {{ userName }}</p>
        <p class="mb-6 ml-1">Key business metrics and recent activities.</p>

        <!-- Top Section: Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
            <p-card styleClass="rounded-lg border h-48 border-gray-200 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow duration-200" (click)="navigateTo('view-clients')">
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <div class="p-2 rounded-full mb-3">
                        <i class="pi pi-users text-blue-600 dark:text-blue-400 text-2xl"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-base font-medium dark:text-slate-200 mb-2">Total Clients</h3>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ stats?.totalActiveClients }}</p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-48 border-gray-200 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow duration-200">
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <div class="p-2 bg-green-100 dark:bg-green-500/20 rounded-full mb-3">
                        <i class="pi pi-chart-line text-green-600 dark:text-green-400 text-2xl"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-base font-medium dark:text-slate-200 mb-2">Total Revenue (Cleared)</h3>
                        <p class="text-xl font-bold text-green-600 dark:text-green-400">
                            KSH {{ stats?.invoiceStats?.totalRevenue | number: '1.2-2' }}
                        </p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-48 border-gray-200 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow duration-200" (click)="navigateTo('view-users')">
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <div class="p-2 bg-indigo-100 dark:bg-indigo-500/20 rounded-full mb-3">
                        <i class="pi pi-shield text-indigo-600 dark:text-indigo-400 text-2xl"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-base font-medium dark:text-slate-200 mb-2">Total Agents</h3>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{{ stats?.totalAgents }}</p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-48 border-gray-200 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow duration-200" (click)="navigateTo('view-leads')">
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <div class="p-2 bg-purple-100 dark:bg-purple-500/20 rounded-full mb-3">
                        <i class="pi pi-briefcase text-purple-600 dark:text-purple-400 text-2xl"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-base font-medium dark:text-slate-200 mb-2">Commitments</h3>
                        <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">{{ stats?.commitMentClients }}</p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-48 border-gray-200 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow duration-200" (click)="navigateTo('view-users')">
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <div class="p-2 bg-teal-100 dark:bg-teal-500/20 rounded-full mb-3">
                        <i class="pi pi-users text-teal-600 dark:text-teal-400 text-2xl"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-base font-medium dark:text-slate-200 mb-2">System Users</h3>
                        <p class="text-3xl font-bold text-teal-600 dark:text-teal-400">{{ stats?.totalSystemUsers }}</p>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Bottom Section: Detailed Cards -->
        <!-- Row 1: Invoice Statistics, Highest Revenue by Client, Super Admins -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <p-card styleClass="rounded-lg border h-64 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-file-invoice-dollar mr-1 text-lg text-indigo-600 dark:text-indigo-400"></i>
                        <h3 class="text-base font-medium">Invoice Statistics</h3>
                    </div>
                </ng-template>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3">
                    <div class="text-center p-2 bg-green-50 dark:bg-green-500/10 rounded-md">
                        <p class="dark:text-slate-300 text-sm">Total Revenue (Cleared)</p>
                        <p class="text-lg font-bold text-green-600 dark:text-green-400">KSH {{ stats?.invoiceStats?.totalRevenue | number: '1.2-2' }}</p>
                    </div>
                    <div class="text-center p-2 bg-yellow-50 dark:bg-yellow-500/10 rounded-md">
                        <p class="dark:text-slate-300 text-sm">Pending to be Cleared</p>
                        <p class="text-lg font-bold text-yellow-600 dark:text-yellow-400">KSH {{ stats?.invoiceStats?.pendingToBeClearedAmount | number: '1.2-2' }}</p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-64 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-star-fill mr-1 text-lg text-blue-600 dark:text-blue-400"></i>
                        <h3 class="text-base font-medium">Highest Revenue by Client</h3>
                    </div>
                </ng-template>
                <div class="flex flex-col items-center justify-center h-full p-3">
                    <p class="dark:text-slate-300 text-sm mb-2">Client: <span class="font-medium text-gray-800 dark:text-slate-100">{{ stats?.highestRevenueClient?.clientName }}</span></p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">KSH {{ stats?.highestRevenueClient?.totalRevenue | number: '1.2-2' }}</p>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-64 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-crown mr-1 text-lg text-amber-600 dark:text-amber-400"></i>
                        <h3 class="text-base font-medium text-amber-700 dark:text-amber-300">Super Admins</h3>
                    </div>
                </ng-template>
                <div class="p-3">
                    <p *ngIf="!stats?.superAdmins?.length" class="dark:text-slate-300 text-sm">No super admins found.</p>
                    <div *ngFor="let admin of stats?.superAdmins" class="flex items-center mb-2">
                        <i class="pi pi-user mr-2 text-amber-500 dark:text-amber-400"></i>
                        <p class="dark:text-slate-300 text-sm" [pTooltip]="'Username: ' + admin.username" tooltipPosition="top">{{ admin.username }}</p>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Row 2: Revenue Over Time and Clients Over Time -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <p-card styleClass="rounded-lg border h-96 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-chart-line mr-1 text-lg text-green-600 dark:text-green-400"></i>
                        <h3 class="text-base font-medium text-green-700 dark:text-green-300">Revenue Over Time</h3>
                    </div>
                </ng-template>
                <div class="p-3 h-[calc(100%-3rem)]">
                    <p-chart type="line" [data]="revenueOverTimeChartData" [options]="timeSeriesChartOptions"></p-chart>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border h-96 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-chart-line mr-1 text-lg text-pink-600 dark:text-pink-400"></i>
                        <h3 class="text-base font-medium text-pink-700 dark:text-pink-300">Clients Over Time</h3>
                    </div>
                </ng-template>
                <div class="p-3 h-[calc(100%-3rem)]">
                    <p-chart type="line" [data]="clientsOverTimeChartData" [options]="clientsOverTimeChartOptions"></p-chart>
                </div>
            </p-card>
        </div>

        <!-- Row 3: Client Source Distribution and Recent Activities -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <p-card styleClass="rounded-lg border h-96 border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-chart-bar mr-1 text-lg text-teal-600 dark:text-teal-400"></i>
                        <h3 class="text-base font-medium text-teal-700 dark:text-teal-300">Client Source Distribution</h3>
                    </div>
                </ng-template>
                <div class="p-3 h-[calc(100%-3rem)]">
                    <p-chart type="bar" [data]="clientSourceChartData" [options]="clientSourceChartOptions"></p-chart>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border  border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-history mr-1 text-lg dark:text-gray-400"></i>
                        <h3 class="text-base font-medium dark:text-slate-300">Recent Activities</h3>
                    </div>
                </ng-template>
                <div class="p-2  overflow-hidden">
                    <p-progressSpinner *ngIf="loading" styleClass="w-8 h-8 mx-auto" strokeWidth="3" animationDuration=".5s"></p-progressSpinner>
                    <div class="h-full overflow-auto">
                        <p-table *ngIf="!loading" [value]="stats?.recentActivities ?? []" [paginator]="true" [rows]="5"
                                 styleClass="p-datatable-sm p-datatable-striped p-datatable-gridlines" responsiveLayout="scroll" [tableStyle]="{'width': '100%'}">
                            <ng-template pTemplate="header">
                                <tr class="bg-gray-50 sticky top-0">
                                    <th class="p-1 text-left text-xs font-medium dark:text-slate-300 w-1/2">Description</th>
                                    <th class="p-1 text-left text-xs font-medium dark:text-slate-300 w-1/6">Client ID</th>
                                    <th class="p-1 text-left text-xs font-medium dark:text-slate-300 w-1/6">Timestamp</th>
                                    <th class="p-1 text-left text-xs font-medium dark:text-slate-300 w-1/6">User</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-activity>
                                <tr class="hover:bg-gray-50 dark:hover:bg-slate-700">
                                    <td class="p-1 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300 text-xs truncate max-w-xs">{{ activity.description }}</td>
                                    <td class="p-1 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300 text-xs">{{ activity.clientId }}</td>
                                    <td class="p-1 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300 text-xs">{{ activity.timestamp | date: 'short' }}</td>
                                    <td class="p-1 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300 text-xs">{{ activity.user || 'System' }}</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="4" class="text-center p-2 text-xs text-gray-500 dark:text-gray-400">No recent activities found.</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </div>
            </p-card>
        </div>
    </div>
</div>

<div *ngIf="hasPrivilege(Permissions.VIEW_CLIENT_DASHBOARD) && stats && !loading && userRole!='SUPER_ADMIN' " class="mb-6 rounded-lg custom-panel max-w-7xl mx-auto">
    <ng-template pTemplate="title">
        <div class="flex items-center p-3 rounded-t-lg">
            <i class="pi pi-user mr-2 text-2xl"></i>
            <h1 class="text-2xl font-semibold">Your Project Dashboard</h1>
        </div>
    </ng-template>

    <div class="p-4">
        <p class="mb-6 ml-1 text-lg font-medium">{{ greeting }}, {{ userName }}</p>
        <p class="mb-6 ml-1">Track your project progress and financials.</p>

        <!-- Top Section: Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <div class="flex items-center p-3">
                    <div class="p-2 bg-blue-100 dark:bg-blue-500/20 rounded-full mr-3">
                        <i class="pi pi-briefcase text-blue-600 dark:text-blue-400 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium dark:text-slate-200">Project Status</h3>
                        <small class="text-sm font-bold text-blue-600 dark:text-blue-400">{{ stats?.projectDetails?.clientStage | titlecase }}</small>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <div class="flex items-center p-3">
                    <div class="p-2 bg-green-100 dark:bg-green-500/20 rounded-full mr-3">
                        <i class="pi pi-chart-line text-green-600 dark:text-green-400 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium dark:text-slate-200">Total Paid</h3>
                        <p class="text-xl font-bold text-green-600 dark:text-green-400">
                            KSH {{ stats?.invoiceStats?.totalRevenue | number: '1.2-2' }}
                        </p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <div class="flex items-center p-3">
                    <div class="p-2 bg-amber-100 dark:bg-amber-500/20 rounded-full mr-3">
                        <i class="pi pi-hourglass text-amber-600 dark:text-amber-400 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium dark:text-slate-200">Pending Payment</h3>
                        <p class="text-xl font-bold text-amber-600 dark:text-amber-400">
                            KSH {{ stats?.invoiceStats?.pendingToBeClearedAmount | number: '1.2-2' }}
                        </p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <div class="flex items-center p-3">
                    <div class="p-2 bg-purple-100 dark:bg-purple-500/20 rounded-full mr-3">
                        <i class="pi pi-box text-purple-600 dark:text-purple-400 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium dark:text-slate-200">Offering</h3>
                        <p class="text-xl font-bold text-purple-600 dark:text-purple-400">{{ stats?.projectDetails?.productOffering | titlecase }}</p>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Bottom Section: Detailed Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-file-invoice-dollar mr-1 text-lg text-indigo-600 dark:text-indigo-400"></i>
                        <h3 class="text-base font-medium">Invoice Statistics</h3>
                    </div>
                </ng-template>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3">
                    <div class="text-center p-2 bg-green-50 dark:bg-green-500/10 rounded-md">
                        <p class="dark:text-slate-300 text-sm">Total Paid</p>
                        <p class="text-lg font-bold text-green-600 dark:text-green-400">KSH {{ stats?.invoiceStats?.totalRevenue | number: '1.2-2' }}</p>
                    </div>
                    <div class="text-center p-2 bg-yellow-50 dark:bg-yellow-500/10 rounded-md">
                        <p class="dark:text-slate-300 text-sm">Pending Payment</p>
                        <p class="text-lg font-bold text-yellow-600 dark:text-yellow-400">KSH {{ stats?.invoiceStats?.pendingToBeClearedAmount | number: '1.2-2' }}</p>
                    </div>
                </div>
            </p-card>

            <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
                <ng-template pTemplate="header">
                    <div class="flex items-center p-2 rounded-t-lg border-b dark:border-slate-600">
                        <i class="pi pi-history mr-1 text-lg dark:text-gray-400"></i>
                        <h3 class="text-base font-medium dark:text-slate-300">Recent Activities</h3>
                    </div>
                </ng-template>
                <div class="p-3">
                    <p-table [value]="stats?.recentActivities ?? []" [paginator]="true" [rows]="5"
                             styleClass="p-datatable-striped p-datatable-gridlines" responsiveLayout="scroll" [tableStyle]="{'min-width': '40rem'}">
                        <ng-template pTemplate="header">
                            <tr class="bg-gray-50 sticky top-0">
                                <th class="p-2 text-left text-sm font-medium dark:text-slate-300 w-1/2">Description</th>
                                <th class="p-2 text-left text-sm font-medium dark:text-slate-300 w-1/6">Client ID</th>
                                <th class="p-2 text-left text-sm font-medium dark:text-slate-300 w-1/6">Timestamp</th>
                                <th class="p-2 text-left text-sm font-medium dark:text-slate-300 w-1/6">User</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-activity>
                            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700">
                                <td class="p-2 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300 truncate max-w-xs">{{ activity.description }}</td>
                                <td class="p-2 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300">{{ activity.clientId }}</td>
                                <td class="p-2 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300">{{ activity.timestamp | date: 'medium' }}</td>
                                <td class="p-2 border-b border-gray-200 dark:border-slate-700 dark:text-slate-300">{{ activity.user || 'System' }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="4" class="text-center p-3 text-gray-500 dark:text-gray-400">No recent activities found.</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </p-card>
        </div>
    </div>
</div>

<div *ngIf="hasPrivilege(Permissions.VIEW_AGENT_DASHBOARD) && agentStats && !agentLoading && userRole!='SUPER_ADMIN'" class="p-4 min-h-screen custom-panel ">
    <div class="mb-6 p-3   rounded-lg">
        <div class="flex items-center">
            <i class="pi pi-shield mr-2 text-2xl"></i>
            <div>
                <h1 class="text-2xl font-semibold">Agent Dashboard</h1>
                <p class="text-sm opacity-90 mt-1">{{ greeting }}, {{ userName }}</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <p-card styleClass="rounded-lg  border border-gray-200 dark:border-slate-700">
            <div class="flex items-center p-3">
                <div class="p-2 rounded-full mr-3">
                    <i class="pi pi-users text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-medium dark:text-slate-200">My Clients</h3>
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ agentStats?.numberOfClients }}</p>

                </div>
            </div>
        </p-card>
        <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
            <div class="flex items-center p-3">
                <div class="p-2 rounded-full mr-3">
                    <i class="pi pi-percentage text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-medium dark:text-slate-200">Commission %</h3>
                    <p class="text-3xl font-bold text-teal-600 dark:text-blue-400">{{ agentStats?.commissionPercentage || 5 }} %</p>
                </div>
            </div>
        </p-card>
        <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
            <div class="flex items-center p-3">
                <div class="p-2 bg-green-100 dark:bg-green-500/20 rounded-full mr-3">
                    <i class="pi pi-money-bill text-green-500 dark:text-green-400 text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-medium dark:text-slate-200">Total Revenue (Cleared)</h3>
<!--                    <p class="text-xl font-bold text-green-600 dark:text-green-400">KSH {{ agentStats?.invoiceStats?.totalRevenue | number: '1.2-2' }}</p>-->
                    <p class="text-xl font-bold text-green-600 dark:text-green-400">KSH {{ 0 | number: '1.2-2' }}</p>
                </div>
            </div>
        </p-card>
        <p-card styleClass="rounded-lg border border-gray-200 dark:border-slate-700">
            <div class="flex items-center p-3">
                <div class="p-2 bg-amber-100 dark:bg-amber-500/20 rounded-full mr-3">
                    <i class="pi pi-hourglass text-amber-500 dark:text-amber-400 text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-base font-medium dark:text-slate-200">Pending Revenue</h3>
<!--                    <p class="text-xl font-bold text-amber-600 dark:text-amber-400">KSH {{ agentStats?.invoiceStats?.pendingToBeClearedAmount | number: '1.2-2' }}</p>-->
                    <p class="text-xl font-bold text-amber-600 dark:text-amber-400">KSH {{0 | number: '1.2-2' }}</p>
                </div>
            </div>
        </p-card>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <p-card styleClass="rounded-lg  border border-gray-200 dark:border-slate-700">
            <ng-template pTemplate="header">
                <div class="flex items-center p-2   rounded-t-lg border-b dark:border-slate-600">
                    <i class="pi pi-address-book mr-1 text-lg text-indigo-700 dark:text-indigo-400"></i>
                    <h3 class="text-base font-medium text-indigo-800 dark:text-indigo-300">My Assigned Clients</h3>
                </div>
            </ng-template>
            <div class="p-2">
                <p-table [value]="agentStats?.clients ?? []" [paginator]="true" [rows]="5" [tableStyle]="{'min-width': '100%'}"
                         responsiveLayout="scroll" styleClass="p-datatable-striped">
                    <ng-template pTemplate="header">
                        <tr class=" ">
                            <th class="p-2 text-left text-sm font-medium  dark:text-slate-300">Name</th>
                            <th class="p-2 text-left text-sm font-medium  dark:text-slate-300">Stage</th>
                            <th class="p-2 text-left text-sm font-medium  dark:text-slate-300">Contact</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-client>
                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-700">
                            <td class="p-2 border-b border-gray-200 dark:border-slate-700  dark:text-slate-300"
                                [pTooltip]="'ID: ' + client.id + '<br>Full Name: ' + client.firstName + ' ' + (client.secondName || '') + ' ' + client.lastName + '<br>Project: ' + (client.projectName || 'N/A') + '<br>Source: ' + (client.clientSource | titlecase) + '<br>Offering: ' + (client.productOffering | titlecase) + '<br>Active: ' + (client.projectActive ? 'Yes' : 'No') + '<br>Follow-up: ' + (client.followUpDate | date: 'mediumDate')"
                                [escape]="false" tooltipPosition="top">
                                {{ client.firstName }} {{ client.lastName }}
                            </td>
                            <td class="p-2 border-b border-gray-200 dark:border-slate-700  dark:text-slate-300">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                      [ngClass]="{
                                        ' text-blue-700 dark:bg-blue-500/30 dark:text-blue-300': client.clientStage === 'PENDING_SITE_VISIT',
                                        'bg-green-100 text-green-700 dark:bg-green-500/30 dark:text-green-300': client.clientStage === 'REQUIREMENTS_GATHERING',
                                        'bg-yellow-100 text-yellow-700 dark:bg-yellow-500/30 dark:text-yellow-300': client.clientStage === 'PROFORMA_INVOICE_GENERATION',
                                        'bg-purple-100 text-purple-700 dark:bg-purple-500/30 dark:text-purple-300': client.clientStage === 'PENDING_CLIENT_BOQ_APPROVALS',
                                        'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200': true
                                      }">
                                    {{ client.clientStage | titlecase }}
                                </span>
                            </td>
                            <td class="p-2 border-b border-gray-200 dark:border-slate-700  dark:text-slate-300"
                                [pTooltip]="'Email: ' + client.email + '<br>Phone: ' + client.countryCode + client.phoneNumber"
                                [escape]="false" tooltipPosition="left">
                                <i class="pi pi-envelope mr-1"></i> / <i class="pi pi-phone ml-1 text-green-500 dark:text-green-400"></i>
                            </td>

                            <td>
                                <i class="pi pi-arrow-up-right hover:cursor-pointer" (click)="viewClient(client)"  style="font-size: 1rem"></i>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="3" class="text-center p-3 text-gray-500 dark:text-gray-400">No clients found.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-card>

        <p-card styleClass="rounded-lg  border border-gray-200 dark:border-slate-700">
            <ng-template pTemplate="header">
                <div class="flex items-center p-2   rounded-t-lg border-b dark:border-slate-600">
                    <i class="pi pi-chart-line mr-1 text-lg text-green-600 dark:text-green-400"></i>
                    <h3 class="text-base font-medium text-green-700 dark:text-green-300">Revenue Over Time</h3>
                </div>
            </ng-template>
            <div class="p-3">
                <p-chart type="line" [data]="agentRevenueOverTimeChartData" [options]="timeSeriesChartOptions"></p-chart>
            </div>
        </p-card>

        <p-card styleClass="rounded-lg  border border-gray-200 dark:border-slate-700">
            <ng-template pTemplate="header">
                <div class="flex items-center p-2    rounded-t-lg border-b ">
                    <i class="pi pi-list-ol mr-1 text-lg "></i>
                    <h3 class="text-base font-medium ">Recent Client Activities</h3>
                </div>
            </ng-template>
            <div class="p-2">
                <p-table [value]="agentStats?.recentActivities ?? []" [paginator]="true" [rows]="5" [tableStyle]="{'min-width': '100%'}"
                         responsiveLayout="scroll" styleClass="p-datatable-striped">
                    <ng-template pTemplate="header">
                        <tr class=" ">
                            <th class="p-2 text-left text-sm font-medium   w-3/5">Description</th>
                            <th class="p-2 text-left text-sm font-medium  ">Timestamp</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-activity>
                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-700"
                            [pTooltip]="'Activity ID: ' + activity.id + '<br>Client: ' + (activity.client?.firstName + ' ' + activity.client?.lastName) + '<br>User: ' + (activity.user || 'System') + '<br>Client Project: ' + (activity.client?.projectName || 'N/A') + '<br>Full Description: ' + activity.description"
                            [escape]="false" tooltipPosition="top">
                            <td class="p-2 border-b border-gray-200 dark:border-slate-700  dark:text-slate-300 truncate max-w-xs"
                                [pTooltip]="activity.description" tooltipPosition="top">
                                {{ activity.description }}
                            </td>
                            <td class="p-2 border-b border-gray-200 dark:border-slate-700  dark:text-slate-300">{{ activity.timestamp | date:'short' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="2" class="text-center p-3 text-gray-500 dark:text-gray-400">No recent activities.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-card>
    </div>
</div>

<div *ngIf="(loading && !hasPrivilege(Permissions.VIEW_AGENT_DASHBOARD)) || (agentLoading && hasPrivilege(Permissions.VIEW_AGENT_DASHBOARD))"
     class="fixed inset-0 bg-gray-300 dark:bg-black bg-opacity-50 dark:bg-opacity-60 z-50 flex items-center justify-center backdrop-blur-sm">
    <p-progressSpinner ariaLabel="Loading Data" styleClass="w-10 h-10 md:w-12 md:h-12" strokeWidth="3" animationDuration=".8s"></p-progressSpinner>
</div>

<ngx-spinner
    bdColor="rgba(0, 0, 0, 0.88)"
    size="large"
    color="#60A5FA"
    type="ball-spin-clockwise-fade"
    [fullScreen]="true"
    [name]="'spinner'">
    <p style="color: #E0E0E0; font-size: 1rem; margin-top: 8px; text-shadow: 0 0 3px black;">Loading Dashboard...</p>
</ngx-spinner>

<ngx-spinner
    bdColor="rgba(0, 0, 0, 0.88)"
    size="large"
    color="#818CF8"
    type="ball-pulse-sync"
    [fullScreen]="true"
    [name]="'agentSpinner'">
    <p style="color: #E0E0E0; font-size: 1rem; margin-top: 8px; text-shadow: 0 0 3px black;">Loading Agent Data...</p>
</ngx-spinner>
